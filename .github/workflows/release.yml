name: Build and Release APK

# Trigger on push to main branch (after PR merge)
# This workflow automatically builds, signs, and releases APK to GitHub Releases
on:
  push:
    branches: [main]
    paths:
      - 'app/src/**'
      - 'app/build.gradle'
      - 'gradle/**'
      - 'build.gradle'
      - 'settings.gradle'

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required to create releases and upload assets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build Release APK
        run: ./gradlew assembleRelease
      
      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"
      
      - name: Get version info
        id: version
        run: |
          # Extract BUILD_NUMBER from BuildConfig.java (generated during build)
          BUILD_NUMBER=$(grep -oP 'BUILD_NUMBER\s*=\s*\K\d+' app/build/generated/source/buildConfig/release/com/ipcam/BuildConfig.java 2>/dev/null || echo "$(date +%Y%m%d%H%M%S)L")
          # Remove trailing 'L' if present
          BUILD_NUMBER="${BUILD_NUMBER%L}"
          
          # Extract version name from version.properties
          VERSION_NAME=$(grep "VERSION_NAME=" version.properties | cut -d'=' -f2)
          
          echo "code=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "name=v$VERSION_NAME (Build $BUILD_NUMBER)" >> $GITHUB_OUTPUT
          echo "tag=v$BUILD_NUMBER" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.name }}
          body: |
            # IP_Cam ${{ steps.version.outputs.name }}
            
            Automated build from commit: ${{ github.sha }}
            
            ## Commit Message
            ${{ github.event.head_commit.message }}
            
            ## Changes
            View diff: ${{ github.event.compare }}
            
            ## Installation
            1. Download the APK file below
            2. Allow installation from unknown sources if prompted
            3. Install the APK
            4. Or use the in-app update feature to install automatically
            
            ## Features
            - MJPEG and RTSP streaming
            - Hardware-accelerated encoding
            - Adaptive quality management
            - Battery-aware streaming
            - OTA updates
            - Web interface with real-time monitoring
            
            ## Endpoints
            - `/stream` - MJPEG video stream
            - `/snapshot` - Single frame snapshot
            - `/status` - Server status (JSON)
            - `/checkUpdate` - Check for updates
            - `/triggerUpdate` - Download and install update
            
            For more information, see: https://github.com/tobi01001/IP_Cam
          files: ${{ steps.sign_app.outputs.signedReleaseFile }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
